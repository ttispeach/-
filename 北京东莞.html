<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>D3 Example</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>
  </head>
  <body>
    <script>
        const data = {
            "东莞轨道交通": [
        {
            "线路": "2号线",
            "首发时间": "2016-5-27",
            "延长线时间": null,
            "起点站": "东莞火车站",
            "终点站": "虎门火车站",
            "车站数": "15",
            "长度（千米）": "37.8",
            "车型编组": "6B",
            "行驶时间（分钟）": null,
            "换乘站数目": null,
            "峰值车速": null,
            "配车数量": null,
            "起点站经度": "113.869367",
            "起点站纬度": "23.070448",
            "终点站经度": "113.671654",
            "终点站纬度": "22.859341"
        }
    ],
            "北京地铁": [
        {
            "线路": "1号线",
            "首发时间": "1971-1-15",
            "延长线时间": "2021-8-29",
            "起点站": "古城",
            "终点站": "四惠东",
            "车站数": "22",
            "长度（千米）": "31",
            "车型编组": "准6B",
            "行驶时间（分钟）": null,
            "换乘站数目": null,
            "峰值车速": null,
            "配车数量": null,
            "起点站经度": "116.190813",
            "起点站纬度": "39.907500",
            "终点站经度": "116.514946",
            "终点站纬度": "39.908047"
        },
        {
            "线路": "2号线",
            "首发时间": "1971-1-15",
            "延长线时间": "1987-12-28",
            "起点站": "环线",
            "终点站": "环线",
            "车站数": "18",
            "长度（千米）": "23.1",
            "车型编组": "准6B",
            "行驶时间（分钟）": null,
            "换乘站数目": null,
            "峰值车速": null,
            "配车数量": null,
            "起点站经度": "116.407387",
            "起点站纬度": "39.904179",
            "终点站经度": "116.407387",
            "终点站纬度": "39.904179"
        },
        {
            "线路": "4号线",
            "首发时间": "2009-9-28",
            "延长线时间": "2010-12-30",
            "起点站": "公益西桥",
            "终点站": "安河桥北",
            "车站数": "24",
            "长度（千米）": "28.2",
            "车型编组": "6B",
            "行驶时间（分钟）": null,
            "换乘站数目": null,
            "峰值车速": null,
            "配车数量": null,
            "起点站经度": "116.370986",
            "起点站纬度": "39.835756",
            "终点站经度": "116.270237",
            "终点站纬度": "40.012521"
        },
        {
            "线路": "5号线",
            "首发时间": "2007-10-7",
            "延长线时间": "-",
            "起点站": "宋家庄",
            "终点站": "天通苑北",
            "车站数": "23",
            "长度（千米）": "27.6",
            "车型编组": "6B",
            "行驶时间（分钟）": null,
            "换乘站数目": null,
            "峰值车速": null,
            "配车数量": null,
            "起点站经度": "116.428281",
            "起点站纬度": "39.845584",
            "终点站经度": "116.413776",
            "终点站纬度": "40.084756"
        },
        {
            "线路": "6号线",
            "首发时间": "2012-12-30",
            "延长线时间": "2018-12-30",
            "起点站": "金安桥",
            "终点站": "潞城",
            "车站数": "34",
            "长度（千米）": "53.1",
            "车型编组": "8B",
            "行驶时间（分钟）": null,
            "换乘站数目": null,
            "峰值车速": null,
            "配车数量": null,
            "起点站经度": "116.161879",
            "起点站纬度": "39.923945",
            "终点站经度": "116.749005",
            "终点站纬度": "39.902279"
        },
        {
            "线路": "7号线",
            "首发时间": "2014-12-28",
            "延长线时间": "2021-8-26",
            "起点站": "北京西站",
            "终点站": "环球度假区",
            "车站数": "30",
            "长度（千米）": "40.3",
            "车型编组": "8B",
            "行驶时间（分钟）": null,
            "换乘站数目": null,
            "峰值车速": null,
            "配车数量": null,
            "起点站经度": "116.312722",
            "起点站纬度": "39.896375",
            "终点站经度": "116.449542",
            "终点站纬度": "39.919842"
        },
        {
            "线路": "8号线",
            "首发时间": "2008-7-19",
            "延长线时间": "2021-12-31",
            "起点站": "朱辛庄",
            "终点站": "瀛海",
            "车站数": "34",
            "长度（千米）": "51.6",
            "车型编组": "6B",
            "行驶时间（分钟）": null,
            "换乘站数目": null,
            "峰值车速": null,
            "配车数量": null,
            "起点站经度": "116.320105",
            "起点站纬度": "40.109711",
            "终点站经度": "116.451811",
            "终点站纬度": "39.756426"
        },
        {
            "线路": "9号线",
            "首发时间": "2011-12-31",
            "延长线时间": "2012-12-30",
            "起点站": "国家图书馆",
            "终点站": "郭公庄",
            "车站数": "13",
            "长度（千米）": "16.5",
            "车型编组": "6B",
            "行驶时间（分钟）": null,
            "换乘站数目": null,
            "峰值车速": null,
            "配车数量": null,
            "起点站经度": "116.323216",
            "起点站纬度": "39.945326",
            "终点站经度": "116.302833",
            "终点站纬度": "39.814250"
        },
        {
            "线路": "10号线",
            "首发时间": "2008-7-19",
            "延长线时间": "2013-5-5",
            "起点站": "环线",
            "终点站": "环线",
            "车站数": "45",
            "长度（千米）": "57.1",
            "车型编组": "6B",
            "行驶时间（分钟）": null,
            "换乘站数目": null,
            "峰值车速": null,
            "配车数量": null,
            "起点站经度": "116.407387",
            "起点站纬度": "39.904179",
            "终点站经度": "116.407387",
            "终点站纬度": "39.904179"
        },
        {
            "线路": "11号线",
            "首发时间": "2021-12-31",
            "延长线时间": "-",
            "起点站": "金安桥",
            "终点站": "新首钢",
            "车站数": "3",
            "长度（千米）": "4.2",
            "车型编组": "4A（预留6A）",
            "行驶时间（分钟）": null,
            "换乘站数目": null,
            "峰值车速": null,
            "配车数量": null,
            "起点站经度": "116.161879",
            "起点站纬度": "39.923945",
            "终点站经度": "116.407526",
            "终点站纬度": "39.904030"
        },
        {
            "线路": "13号线",
            "首发时间": "2002-9-28",
            "延长线时间": "2003-1-28",
            "起点站": "西直门",
            "终点站": "东直门",
            "车站数": "17",
            "长度（千米）": "40.9",
            "车型编组": "准6B",
            "行驶时间（分钟）": null,
            "换乘站数目": null,
            "峰值车速": null,
            "配车数量": null,
            "起点站经度": "116.353436",
            "起点站纬度": "39.941423",
            "终点站经度": "116.435324",
            "终点站纬度": "39.941640"
        },
        {
            "线路": "14号线",
            "首发时间": "2013-5-5",
            "延长线时间": "2021-12-31",
            "起点站": "张郭庄",
            "终点站": "善各庄",
            "车站数": "33",
            "长度（千米）": "50.8",
            "车型编组": "6A",
            "行驶时间（分钟）": null,
            "换乘站数目": null,
            "峰值车速": null,
            "配车数量": null,
            "起点站经度": "116.186969",
            "起点站纬度": "39.857625",
            "终点站经度": "116.474424",
            "终点站纬度": "40.028014"
        },
        {
            "线路": "15号线",
            "首发时间": "2010-12-30",
            "延长线时间": "2014-12-28",
            "起点站": "清华东路西口",
            "终点站": "俸伯",
            "车站数": "20",
            "长度（千米）": "41.4",
            "车型编组": "6B",
            "行驶时间（分钟）": null,
            "换乘站数目": null,
            "峰值车速": null,
            "配车数量": null,
            "起点站经度": "116.360405",
            "起点站纬度": "40.001491",
            "终点站经度": "116.468532",
            "终点站纬度": "39.998367"
        },
        {
            "线路": "16号线",
            "首发时间": "2016-12-31",
            "延长线时间": "2022-12-31",
            "起点站": "北安河",
            "终点站": "榆树庄",
            "车站数": "26",
            "长度（千米）": "45.5",
            "车型编组": "8A",
            "行驶时间（分钟）": null,
            "换乘站数目": null,
            "峰值车速": null,
            "配车数量": null,
            "起点站经度": "116.407267",
            "起点站纬度": "40.056289",
            "终点站经度": "116.254978",
            "终点站纬度": "39.841707"
        },
        {
            "线路": "17号线",
            "首发时间": "2021-12-31",
            "延长线时间": "-",
            "起点站": "十里河",
            "终点站": "嘉会湖",
            "车站数": "7",
            "长度（千米）": "15.8",
            "车型编组": "8A",
            "行驶时间（分钟）": null,
            "换乘站数目": null,
            "峰值车速": null,
            "配车数量": null,
            "起点站经度": "116.461084",
            "起点站纬度": "39.859421",
            "终点站经度": "116.610369",
            "终点站纬度": "39.792902"
        },
        {
            "线路": "19号线",
            "首发时间": "2021-12-31",
            "延长线时间": "-",
            "起点站": "牡丹园",
            "终点站": "新宫",
            "车站数": "10",
            "长度（千米）": "20.9",
            "车型编组": "8A",
            "行驶时间（分钟）": null,
            "换乘站数目": null,
            "峰值车速": null,
            "配车数量": null,
            "起点站经度": "116.368776",
            "起点站纬度": "39.976329",
            "终点站经度": "116.366750",
            "终点站纬度": "39.805937"
        },
        {
            "线路": "八通线",
            "首发时间": "2003-12-27",
            "延长线时间": "2021-8-29",
            "起点站": "高碑店",
            "终点站": "环球度假区",
            "车站数": "13",
            "长度（千米）": "23.4",
            "车型编组": "准6B",
            "行驶时间（分钟）": null,
            "换乘站数目": null,
            "峰值车速": null,
            "配车数量": null,
            "起点站经度": "116.407526",
            "起点站纬度": "39.904030",
            "终点站经度": "116.449542",
            "终点站纬度": "39.919842"
        },
        {
            "线路": "大兴线",
            "首发时间": "2010-12-30",
            "延长线时间": "-",
            "起点站": "新宫",
            "终点站": "天宫院",
            "车站数": "11",
            "长度（千米）": "21.8",
            "车型编组": "6B",
            "行驶时间（分钟）": null,
            "换乘站数目": null,
            "峰值车速": null,
            "配车数量": null,
            "起点站经度": "116.366750",
            "起点站纬度": "39.805937",
            "终点站经度": "116.319759",
            "终点站纬度": "39.669518"
        },
        {
            "线路": "亦庄线",
            "首发时间": "2010-12-30",
            "延长线时间": "2018-12-30",
            "起点站": "宋家庄",
            "终点站": "亦庄火车站",
            "车站数": "14",
            "长度（千米）": "23.2",
            "车型编组": "6B",
            "行驶时间（分钟）": null,
            "换乘站数目": null,
            "峰值车速": null,
            "配车数量": null,
            "起点站经度": "116.428281",
            "起点站纬度": "39.845584",
            "终点站经度": "116.601847",
            "终点站纬度": "39.812739"
        },
        {
            "线路": "昌平线",
            "首发时间": "2010-12-30",
            "延长线时间": "2023-2-4",
            "起点站": "昌平西山口",
            "终点站": "西土城",
            "车站数": "18",
            "长度（千米）": "43.5",
            "车型编组": "6B",
            "行驶时间（分钟）": null,
            "换乘站数目": null,
            "峰值车速": null,
            "配车数量": null,
            "起点站经度": "116.393550",
            "起点站纬度": "39.948750",
            "终点站经度": "116.352001",
            "终点站纬度": "39.976736"
        },
        {
            "线路": "房山线",
            "首发时间": "2010-12-30",
            "延长线时间": "2023-1-18",
            "起点站": "国家图书馆",
            "终点站": "阎村东",
            "车站数": "16",
            "长度（千米）": "31.8",
            "车型编组": "6B",
            "行驶时间（分钟）": null,
            "换乘站数目": null,
            "峰值车速": null,
            "配车数量": null,
            "起点站经度": "116.323216",
            "起点站纬度": "39.945326",
            "终点站经度": "116.092378",
            "终点站纬度": "39.716162"
        },
        {
            "线路": "房山线",
            "首发时间": "2010-12-30",
            "延长线时间": "2023-1-18",
            "起点站": "东管头南",
            "终点站": "阎村东",
            "车站数": "16",
            "长度（千米）": "31.8",
            "车型编组": "6B",
            "行驶时间（分钟）": null,
            "换乘站数目": null,
            "峰值车速": null,
            "配车数量": null,
            "起点站经度": "116.316078",
            "起点站纬度": "39.863103",
            "终点站经度": "116.092378",
            "终点站纬度": "39.716162"
        },
        {
            "线路": "燕房线",
            "首发时间": "2017-12-30",
            "延长线时间": "-",
            "起点站": "阎村东",
            "终点站": "燕山",
            "车站数": "9",
            "长度（千米）": "14.4",
            "车型编组": "4B（预留6B）",
            "行驶时间（分钟）": null,
            "换乘站数目": null,
            "峰值车速": null,
            "配车数量": null,
            "起点站经度": "116.092378",
            "起点站纬度": "39.716162",
            "终点站经度": "115.958419",
            "终点站纬度": "39.749012"
        },
        {
            "线路": "S1线",
            "首发时间": "2017-12-30",
            "延长线时间": "2021-12-31",
            "起点站": "石厂",
            "终点站": "苹果园",
            "车站数": "8",
            "长度（千米）": "10.2",
            "车型编组": "6节编组（中低速磁浮）",
            "行驶时间（分钟）": null,
            "换乘站数目": null,
            "峰值车速": null,
            "配车数量": null,
            "起点站经度": "116.622962",
            "起点站纬度": "40.300418",
            "终点站经度": "116.148274",
            "终点站纬度": "39.938786"
        },
        {
            "线路": "首都机场线",
            "首发时间": "2008-7-19",
            "延长线时间": "2021-12-31",
            "起点站": "北新桥",
            "终点站": "3号航站楼",
            "车站数": "5",
            "长度（千米）": "30",
            "车型编组": "4LB",
            "行驶时间（分钟）": null,
            "换乘站数目": null,
            "峰值车速": null,
            "配车数量": null,
            "起点站经度": "116.407267",
            "起点站纬度": "40.056289",
            "终点站经度": "116.614863",
            "终点站纬度": "40.054894"
        },
        {
            "线路": "首都机场线",
            "首发时间": "2008-7-19",
            "延长线时间": "2021-12-31",
            "起点站": "北新桥",
            "终点站": "2号航站楼",
            "车站数": "5",
            "长度（千米）": "30",
            "车型编组": "4LB",
            "行驶时间（分钟）": null,
            "换乘站数目": null,
            "峰值车速": null,
            "配车数量": null,
            "起点站经度": "116.407267",
            "起点站纬度": "40.056289",
            "终点站经度": "116.351522",
            "终点站纬度": "39.984525"
        },
        {
            "线路": "大兴机场线",
            "首发时间": "2019-9-26",
            "延长线时间": "-",
            "起点站": "草桥",
            "终点站": "大兴机场",
            "车站数": "3",
            "长度（千米）": "41.36",
            "车型编组": "8D/4D（市域快轨）",
            "行驶时间（分钟）": null,
            "换乘站数目": null,
            "峰值车速": null,
            "配车数量": null,
            "起点站经度": "116.346605",
            "起点站纬度": "39.844870",
            "终点站经度": "116.341014",
            "终点站纬度": "39.784747"
        },
        {
            "线路": "西郊线",
            "首发时间": "2017-12-30",
            "延长线时间": "-",
            "起点站": "香山",
            "终点站": "巴沟",
            "车站数": "6",
            "长度（千米）": "9",
            "车型编组": "5节/10节编组（有轨电车）",
            "行驶时间（分钟）": null,
            "换乘站数目": null,
            "峰值车速": null,
            "配车数量": null,
            "起点站经度": "116.201153",
            "起点站纬度": "39.996569",
            "终点站经度": "116.295250",
            "终点站纬度": "39.973800"
        },
        {
            "线路": "亦庄T1线",
            "首发时间": "2020-12-31",
            "延长线时间": "-",
            "起点站": "屈庄",
            "终点站": "定海园",
            "车站数": "14",
            "长度（千米）": "11.9",
            "车型编组": "5节编组（有轨电车）",
            "行驶时间（分钟）": null,
            "换乘站数目": null,
            "峰值车速": null,
            "配车数量": null,
            "起点站经度": "116.407526",
            "起点站纬度": "39.904030",
            "终点站经度": "116.564964",
            "终点站纬度": "39.798420"
        }
    ],
        };
      // set up the SVG element
      const svg = d3.select("body").append("svg")
          .attr("width", 5000)
          .attr("height", 5000);

          
// create a scale for the x and y positions of the elements
const xScale = d3.scaleLinear()
    .domain([114, 118])
    .range([50, 450]);
const yScale = d3.scaleLinear()
    .domain([38, 42])
    .range([450, 50]);

const xScale2 = d3.scaleLinear()
    .domain([115.5, 116])
    .range([50, 450]);
const yScale2 = d3.scaleLinear()
    .domain([39.5, 40])
    .range([450, 50]);

      // add the city square
      svg.append("rect")
          .attr("x", xScale(115))
          .attr("y", yScale(41))
          .attr("width", xScale(117) - xScale(115))
          .attr("height", yScale(39) - yScale(41))
          .style("fill", "none")
          .style("stroke", "black");

      // add the city center
      const cityCenterX = (xScale(115) + xScale(117)) / 2;
      const cityCenterY = (yScale(39) + yScale(41)) / 2;

      const lineGenerator = d3.line()
          .x(d => d.x)
          .y(d => d.y);


// 定义 clipPath
svg.append("clipPath")
    .attr("id", "city-square-clip")
    .append("rect")
    .attr("x", xScale(115))
    .attr("y", yScale(41))
    .attr("width", xScale(117) - xScale(115))
    .attr("height", yScale(39) - yScale(41));


const minSize = 50; // 最小大小
const maxSize = 150; // 最大大小
const squareSize = Math.random() * (maxSize - minSize) + minSize; // 生成一个在最小和最大大小之间的随机数

data["北京地铁"].forEach(line => {
            // svg.append("circle")
            //     .attr("cx", cityCenterX + (xScale2(line["起点站经度"]) - xScale2(116.395645)))
            //     .attr("cy", cityCenterY + (yScale2(line["起点站纬度"]) - yScale2(39.929986)))
            //     .attr("r", 2)
            //     .style("fill", "red");
            // svg.append("circle")
            //     .attr("cx", cityCenterX + (xScale2(line["终点站经度"]) - xScale2(116.395645)))
            //     .attr("cy", cityCenterY + (yScale2(line["终点站纬度"]) - yScale2(39.929986)))
            //     .attr("r", 2)
            //     .style("fill", "red");


            const startX = cityCenterX + (xScale2(line["起点站经度"]) - xScale2(116.395645));
            const startY = cityCenterY + (yScale2(line["起点站纬度"]) - yScale2(39.929986));
            const endX = cityCenterX + (xScale2(line["终点站经度"]) - xScale2(116.395645));
            const endY = cityCenterY + (yScale2(line["终点站纬度"]) - yScale2(39.929986));

            const deltaX = endX - startX;
            const deltaY = endY - startY;
            const length = Math.sqrt(deltaX * deltaX + deltaY * deltaY);

        // 应用 clipPath
        if (length > 0) {
            const extension = 600;
            const extendedLength = length + extension;
            const extendedStartX = startX - (deltaX / length) * extension / 2;
            const extendedStartY = startY - (deltaY / length) * extension / 2;
            const extendedEndX = startX + (deltaX / length) * extendedLength;
            const extendedEndY = startY + (deltaY / length) * extendedLength;

            svg.append("path")
                .datum([
                    {x: extendedStartX, y: extendedStartY},
                    {x: extendedEndX, y: extendedEndY}
                ])
                .attr("d", lineGenerator)
                .style("fill", "none")
                .style("stroke", "black")
                .attr("clip-path", "url(#city-square-clip)"); // 应用 clipPath
        } 
        // else {
        //     svg.append("rect")
        //         .attr("x", startX - squareSize / 2)
        //         .attr("y", startY - squareSize / 2)
        //         .attr("width", squareSize)
        //         .attr("height", squareSize)
        //         .style("fill", "none")
        //         .style("stroke", "black");
        // }
        else {
            const minRadius = 25; // 最小半径
            const maxRadius = 75; // 最大半径
            const radius = Math.random() * (maxRadius - minRadius) + minRadius; // 生成一个在最小和最大半径之间的随机数

            svg.append("circle")
                .attr("cx", startX)
                .attr("cy", startY)
                .attr("r", radius)
                .style("fill", "none")
                .style("stroke", "black");
        }

});

// add the Dongguan square
// 113.763434,23.043024

svg.append("rect")
    .attr("x", xScale(117))
    .attr("y", yScale(41))
    .attr("width", xScale(119) - xScale(117))
    .attr("height", yScale(39) - yScale(41))
    .style("fill", "none")
    .style("stroke", "black");

const dongguanCenterX = (xScale(117) + xScale(119)) / 2;
const dongguanCenterY = (yScale(39) + yScale(41)) / 2;

// 定义东莞方格的 clipPath
svg.append("clipPath")
    .attr("id", "dongguan-square-clip")
    .append("rect")
    .attr("x", xScale(117))
    .attr("y", yScale(41))
    .attr("width", xScale(119) - xScale(117))
    .attr("height", yScale(39) - yScale(41));



data["东莞轨道交通"].forEach(line => {
            // svg.append("circle")
            //     .attr("cx", dongguanCenterX + (xScale(line["起点站经度"]) - xScale(113.763434)))
            //     .attr("cy", dongguanCenterY + (yScale(line["起点站纬度"]) - yScale(23.048884)))
            //     .attr("r", 2)
            //     .style("fill", "red");
            // svg.append("circle")
            //     .attr("cx", dongguanCenterX + (xScale(line["终点站经度"]) - xScale(113.763434)))
            //     .attr("cy", dongguanCenterY + (yScale(line["终点站纬度"]) - yScale(23.048884)))                
            //     .attr("r", 2)
            //     .style("fill", "red");


            const startX = dongguanCenterX + (xScale(line["起点站经度"]) - xScale(113.763434));
            const startY = dongguanCenterY + (yScale(line["起点站纬度"]) - yScale(23.048884));
            const endX = dongguanCenterX + (xScale(line["终点站经度"]) - xScale(113.763434));
            const endY = dongguanCenterY + (yScale(line["终点站纬度"]) - yScale(23.048884));

            const deltaX = endX - startX;
            const deltaY = endY - startY;
            const length = Math.sqrt(deltaX * deltaX + deltaY * deltaY);

        // 应用 clipPath
        if (length > 0) {
            const extension = 600;
            const extendedLength = length + extension;
            const extendedStartX = startX - (deltaX / length) * extension / 2;
            const extendedStartY = startY - (deltaY / length) * extension / 2;
            const extendedEndX = startX + (deltaX / length) * extendedLength;
            const extendedEndY = startY + (deltaY / length) * extendedLength;

            svg.append("path")
                .datum([
                    {x: extendedStartX, y: extendedStartY},
                    {x: extendedEndX, y: extendedEndY}
                ])
                .attr("d", lineGenerator)
                .style("fill", "none")
                .style("stroke", "black")
                .style("stroke-width", 10) // 设置线条宽度
                .attr("clip-path", "url(#dongguan-square-clip)"); // 应用 clipPath
        } 
        // else {
        //     svg.append("rect")
        //         .attr("x", startX - squareSize / 2)
        //         .attr("y", startY - squareSize / 2)
        //         .attr("width", squareSize)
        //         .attr("height", squareSize)
        //         .style("fill", "none")
        //         .style("stroke", "black");
        // }
        else {
            const minRadius = 25; // 最小半径
            const maxRadius = 75; // 最大半径
            const radius = Math.random() * (maxRadius - minRadius) + minRadius; // 生成一个在最小和最大半径之间的随机数

            svg.append("circle")
                .attr("cx", startX)
                .attr("cy", startY)
                .attr("r", radius)
                .style("fill", "none")
                .style("stroke", "black");
        }

});


    </script>
  </body>
</html>
